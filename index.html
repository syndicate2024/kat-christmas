<!DOCTYPE html>
<html>
	<head>
		<title>Christmas Animation</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&display=swap"
			rel="stylesheet"
		/>
		<script
			async
			src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.159.0/three.min.js"
		></script>
		<style>
			body {
				margin: 0;
				overflow: hidden;
				background: linear-gradient(to bottom, #1a1a1a, #000000);
			}
			#scene-container {
				position: fixed;
				width: 100%;
				height: 100%;
				background: url('./winter-scene.jpg') no-repeat center center fixed;
				background-size: cover;
			}
			/* Update the message-container styles */
			.message-container {
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				height: 70vh;
				background: linear-gradient(
					to top,
					rgba(0, 0, 0, 0.95) 0%,
					rgba(0, 0, 0, 0.8) 80%,
					transparent 100%
				);
				color: white;
				z-index: 1000;
				opacity: 0;
				transition: opacity 3s ease-out;
				transform: translateY(0);
			}

			.message-container.fade-in {
				opacity: 1 !important;
				animation: scrollContainer 45s linear forwards;
			}

			@keyframes scrollContainer {
				0% {
					transform: translateY(0);
				}
				85% {
					transform: translateY(-100vh);
				}
				100% {
					transform: translateY(-120vh);
				}
			}

			/* Update the message-text animation timing to match */
			@keyframes scrollText {
				0% {
					transform: translateY(180%);
				}
				5% {
					transform: translateY(110%);
				}
				85% {
					transform: translateY(-120%);
				}
				100% {
					transform: translateY(-150%);
				}
			}

			.message-text {
				max-width: 800px;
				margin: 0 auto;
				font-size: 1.8rem;
				line-height: 2;
				text-align: center;
				text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
				padding: 2rem;
				font-family: 'Cormorant Garamond', serif;
				position: relative;
				transform: translateY(120%);
			}
			.fade-in {
				opacity: 1 !important;
			}
			.message-text.animate {
				animation: scrollText 45s linear forwards;
			}
			@keyframes scrollText {
				0% {
					transform: translateY(120%);
				}
				5% {
					transform: translateY(110%);
				}
				85% {
					transform: translateY(-120%);
				}
				100% {
					transform: translateY(-150%);
				}
			}
			.start-heart {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 150px;
				height: 150px;
				cursor: pointer;
				z-index: 2000;
				background: none;
				border: none;
				outline: none;
				animation: heartbeat 1.2s ease-in-out infinite;
			}
			.start-heart::after {
				content: '';
				position: absolute;
				top: 0;
				left: -50%;
				width: 200%;
				height: 100%;
				background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
				transform: skewX(-20deg);
				animation: shine 2s infinite;
			}
			@keyframes heartbeat {
				0% {
					transform: translate(-50%, -50%) scale(1);
				}
				5% {
					transform: translate(-50%, -50%) scale(1.15);
				}
				10% {
					transform: translate(-50%, -50%) scale(1.05);
				}
				15% {
					transform: translate(-50%, -50%) scale(1.2);
				}
				50% {
					transform: translate(-50%, -50%) scale(1);
				}
				100% {
					transform: translate(-50%, -50%) scale(1);
				}
			}
			@keyframes shine {
				0% {
					left: -50%;
					opacity: 0;
				}
				20% {
					opacity: 0.8;
				}
				40% {
					opacity: 0;
				}
				100% {
					left: 150%;
					opacity: 0;
				}
			}
			.hidden {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<div
			id="loading"
			style="
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: white;
				font-family: sans-serif;
				z-index: 9999;
			"
		>
			Loading...
		</div>
		<div id="scene-container"></div>
		<button class="start-heart" id="start-button" style="display: none">
			<svg viewBox="0 0 100 100" width="100%" height="100%">
				<path
					fill="#9370DB"
					d="M50,88.87 C76.67,70.46 90,53.9 90,39.17 C90,17.08 63.39,3.84 50,27.63 C36.61,3.84 10,17.08 10,39.17 C10,53.9 23.33,70.46 50,88.87 Z"
				/>
			</svg>
		</button>
		<div class="message-container">
			<div class="message-text">
				Though this is our first Christmas together, and while our journey has just begun, I find
				myself falling deeper in love with you each passing day. Every moment we share becomes a
				treasured memory, every laugh we exchange echoes in my heart, and every quiet moment
				together feels like home. Your smile brightens even the darkest winter days, and your love
				warms my soul like no other. As the snow falls and the world turns white, I can't help but
				dream of all the Christmases we'll share, all the traditions we'll build, and all the
				memories we'll create together. You've shown me what true love feels like, and I know that
				every Christmas morning from now on will be magical because I'll get to spend it with you. I
				cherish every second we have together, and I can't wait to build our future, one beautiful
				moment at a time. You are my greatest gift, my perfect match, and my forever love. Merry
				Christmas, my love.
			</div>
		</div>

		<script>
			// Add error handling for Three.js loading
			function checkThreeJS() {
				return new Promise((resolve, reject) => {
					if (window.THREE) {
						resolve();
					} else {
						const maxAttempts = 20;
						let attempts = 0;
						const checkInterval = setInterval(() => {
							attempts++;
							if (window.THREE) {
								clearInterval(checkInterval);
								resolve();
							} else if (attempts >= maxAttempts) {
								clearInterval(checkInterval);
								reject(new Error('Failed to load Three.js'));
							}
						}, 250);
					}
				});
			}

			function loadAudio(url) {
				return new Promise((resolve, reject) => {
					const audio = new Audio(url);
					audio.addEventListener('canplaythrough', () => resolve(audio));
					audio.addEventListener('error', () => reject(new Error('Failed to load audio')));
					audio.load();
				});
			}

			// Global state
			let hasClicked = false;
			let snowflakesVisible = false;
			let explosionParticles = [];
			let explosionTime = 0;
			const depthRange = { min: -20, max: 10 };

			async function init() {
				try {
					await checkThreeJS();
					const backgroundMusic = await loadAudio("./Five_O'Clock_-_JEKK.mp3");

					// Hide loading indicator and show start button
					document.getElementById('loading').style.display = 'none';
					document.getElementById('start-button').style.display = 'block';

					// Scene setup
					const scene = new THREE.Scene();
					const camera = new THREE.PerspectiveCamera(
						75,
						window.innerWidth / window.innerHeight,
						0.1,
						1000
					);
					const renderer = new THREE.WebGLRenderer({
						alpha: true,
						antialias: true,
					});
					renderer.setSize(window.innerWidth, window.innerHeight);
					document.getElementById('scene-container').appendChild(renderer.domElement);

					// Create detailed snowflake geometry
					function createSnowflakeGeometry(size) {
						const geometry = new THREE.BufferGeometry();
						const vertices = [];

						for (let i = 0; i < 6; i++) {
							const angle = (i * Math.PI * 2) / 6;
							vertices.push(0, 0, 0);
							vertices.push(Math.cos(angle) * size, Math.sin(angle) * size, 0);

							const subSize = size * 0.6;
							const subAngle1 = angle + Math.PI / 6;
							const subAngle2 = angle - Math.PI / 6;

							vertices.push(Math.cos(angle) * size * 0.5, Math.sin(angle) * size * 0.5, 0);
							vertices.push(
								Math.cos(angle) * size * 0.5 + Math.cos(subAngle1) * subSize * 0.5,
								Math.sin(angle) * size * 0.5 + Math.sin(subAngle1) * subSize * 0.5,
								0
							);

							vertices.push(Math.cos(angle) * size * 0.5, Math.sin(angle) * size * 0.5, 0);
							vertices.push(
								Math.cos(angle) * size * 0.5 + Math.cos(subAngle2) * subSize * 0.5,
								Math.sin(angle) * size * 0.5 + Math.sin(subAngle2) * subSize * 0.5,
								0
							);
						}

						geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
						return geometry;
					}

					// Create heart geometry
					function create3DHeartGeometry(size) {
						const x = 0,
							y = 0;

						const heartShape = new THREE.Shape();
						heartShape.moveTo(x + 25, y + 25);
						heartShape.bezierCurveTo(x + 25, y + 25, x + 20, y, x, y);
						heartShape.bezierCurveTo(x - 30, y, x - 30, y + 35, x - 30, y + 35);
						heartShape.bezierCurveTo(x - 30, y + 55, x - 10, y + 77, x + 25, y + 95);
						heartShape.bezierCurveTo(x + 60, y + 77, x + 80, y + 55, x + 80, y + 35);
						heartShape.bezierCurveTo(x + 80, y + 35, x + 80, y, x + 50, y);
						heartShape.bezierCurveTo(x + 35, y, x + 25, y + 25, x + 25, y + 25);

						const extrudeSettings = {
							depth: 8,
							bevelEnabled: true,
							bevelSegments: 8,
							steps: 2,
							bevelSize: 3,
							bevelThickness: 3,
						};

						const geometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
						geometry.scale(size * 0.01, size * 0.01, size * 0.01);
						geometry.center();
						return geometry;
					}

					// Create snow particles
					const snowParticles = [];
					const particleCount = 1000;

					for (let i = 0; i < particleCount; i++) {
						const size = Math.random() * 0.5 + 0.3;
						const geometry = createSnowflakeGeometry(size);
						const material = new THREE.LineBasicMaterial({
							color: 0xffffff,
							transparent: true,
							opacity: Math.random() * 0.5 + 0.5,
						});

						const particle = new THREE.LineSegments(geometry, material);

						const zPos = Math.random() * (depthRange.max - depthRange.min) + depthRange.min;
						const spreadFactor = (zPos - depthRange.min) / (depthRange.max - depthRange.min);
						const spread = 150 - spreadFactor * 100;

						particle.position.set(
							Math.random() * spread - spread / 2,
							Math.random() * 200 - 100,
							zPos
						);

						particle.userData.rotationSpeed = (Math.random() - 0.5) * 0.01;
						particle.userData.fallSpeed = Math.random() * 0.15 + 0.01;
						particle.userData.wobbleSpeed = Math.random() * 0.02;
						particle.userData.wobbleAmplitude = Math.random() * 0.1;
						particle.userData.initialX = particle.position.x;
						particle.userData.zPos = zPos;

						snowParticles.push(particle);
					}

					// Create explosion particles
					function createExplosionParticles(count) {
						const particles = [];
						const heartGeometry = create3DHeartGeometry(0.5);

						for (let i = 0; i < count; i++) {
							const material = new THREE.MeshPhongMaterial({
								color: 0xff0000,
								emissive: 0xff0000,
								emissiveIntensity: 0.5,
								shininess: 80,
								transparent: true,
								opacity: 0.9,
								side: THREE.DoubleSide,
							});

							const heart = new THREE.Mesh(heartGeometry, material);
							heart.position.set(0, 0, -10);

							const theta = Math.random() * Math.PI * 2;
							const phi = Math.random() * Math.PI;
							const speed = Math.random() * 0.8 + 0.7; // Increased speed

							heart.userData.velocity = new THREE.Vector3(
								Math.sin(phi) * Math.cos(theta),
								Math.sin(phi) * Math.sin(theta),
								Math.cos(phi)
							).multiplyScalar(speed * 0.5); // Increased multiplier

							heart.userData.rotationSpeed = new THREE.Vector3(
								Math.random() - 0.5,
								Math.random() - 0.5,
								Math.random() - 0.5
							).multiplyScalar(0.05);

							particles.push(heart);
							scene.add(heart);
						}
						return particles;
					}

					// Add lighting
					const pointLight = new THREE.PointLight(0xffffff, 1);
					pointLight.position.set(0, 0, 5);
					scene.add(pointLight);

					const ambientLight = new THREE.AmbientLight(0x404040);
					scene.add(ambientLight);

					// Position camera
					camera.position.z = 15;

					// Animation function
					function animate() {
						requestAnimationFrame(animate);

						// Animate explosion particles
						if (explosionParticles.length > 0) {
							const elapsed = Date.now() - explosionTime;
							const progress = Math.min(elapsed / 6000, 1); // Increased from 4000 to 6000ms

							explosionParticles.forEach((particle, i) => {
								let speed;
								if (progress < 0.6) {
									// Changed from 0.5 to 0.6
									speed = 0.3 - progress * 0.2; // Increased initial speed
								} else {
									speed = 0.05 * (1 - (progress - 0.6) * 2.5); // Adjusted slowdown
								}

								particle.position.add(particle.userData.velocity.clone().multiplyScalar(speed));

								particle.rotation.x += particle.userData.rotationSpeed.x * 0.1;
								particle.rotation.y += particle.userData.rotationSpeed.y * 0.1;
								particle.rotation.z += particle.userData.rotationSpeed.z * 0.1;

								if (progress > 0.8) {
									particle.material.opacity = (1 - progress) * 5;
								}

								if (progress === 1) {
									scene.remove(particle);
									if (i === explosionParticles.length - 1) {
										explosionParticles = [];
									}
								}
							});
						}

						// Animate snow particles
						if (snowflakesVisible) {
							snowParticles.forEach((particle) => {
								particle.position.y -= particle.userData.fallSpeed;
								particle.rotation.z += particle.userData.rotationSpeed;

								particle.position.x =
									particle.userData.initialX +
									Math.sin(Date.now() * particle.userData.wobbleSpeed) *
										particle.userData.wobbleAmplitude;

								if (particle.position.y < -100) {
									particle.position.y = 100;
									particle.position.x = Math.random() * 200 - 100;
									particle.userData.initialX = particle.position.x;
								}
							});
						}

						renderer.render(scene, camera);
					}

					// Handle window resize
					window.addEventListener('resize', onWindowResize, false);

					function onWindowResize() {
						camera.aspect = window.innerWidth / window.innerHeight;
						camera.updateProjectionMatrix();
						renderer.setSize(window.innerWidth, window.innerHeight);
					}

					// Start animation
					animate();

					// Click handler
					document.getElementById('start-button').addEventListener('click', function () {
						if (!hasClicked) {
							hasClicked = true;

							// Start music and explosion
							backgroundMusic.play();
							this.classList.add('hidden');
							explosionParticles = createExplosionParticles(100);
							explosionTime = Date.now();

							// Show text after explosion (4 seconds)
							setTimeout(() => {
								document.querySelector('.message-container').classList.add('fade-in');
								document.querySelector('.message-text').classList.add('animate');
							}, 4000);

							// Add snowflakes after text starts
							setTimeout(() => {
								snowParticles.forEach((particle) => scene.add(particle));
								snowflakesVisible = true;
							}, 5000);

							// Transform snowflakes to hearts after 45 seconds
							setTimeout(() => {
								snowParticles.forEach((particle, index) => {
									setTimeout(() => {
										const zPos = particle.userData.zPos;
										const depthFactor = (zPos - depthRange.min) / (depthRange.max - depthRange.min);
										const size = 0.8 - depthFactor * 0.4;
										const heartGeometry = create3DHeartGeometry(size);

										const heartMaterial = new THREE.MeshPhongMaterial({
											color: 0xff0000,
											emissive: 0xff0000,
											emissiveIntensity: 0.5,
											shininess: 80,
											transparent: true,
											opacity: 0.9,
											side: THREE.DoubleSide,
										});

										const heart = new THREE.Mesh(heartGeometry, heartMaterial);
										heart.position.copy(particle.position);
										heart.userData = { ...particle.userData };

										scene.remove(particle);
										scene.add(heart);
										snowParticles[index] = heart;
									}, Math.random() * 3000);
								});
							}, 45000);

							// Start fading out music near the end
							setTimeout(() => {
								const fadeInterval = setInterval(() => {
									if (backgroundMusic.volume > 0.01) {
										backgroundMusic.volume -= 0.01;
									} else {
										backgroundMusic.pause();
										clearInterval(fadeInterval);
									}
								}, 50);
							}, 165000); // 2:45 (165 seconds)
						}
					});
				} catch (error) {
					console.error('Failed to initialize:', error);
					document.getElementById('loading').textContent =
						'Failed to load resources. Please refresh the page.';
				}
			}

			// Start initialization when page loads
			window.addEventListener('load', init);
		</script>
	</body>
</html>
